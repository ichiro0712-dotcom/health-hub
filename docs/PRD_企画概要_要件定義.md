# Health Hub - 企画概要・要件定義書

## 1. 企画概要

### 1.1 サービス概要

**Health Hub** は、個人の健康データを一元管理し、健康状態の「見える化」と継続的な健康管理を支援するWebアプリケーションです。

健康診断データ、ウェアラブルデバイス（Fitbit）のデータ、日々の習慣記録を統合し、AIによる健康分析・アドバイス機能を通じて、ユーザーの健康増進をサポートします。

### 1.2 ターゲットユーザー

- **主要ターゲット**: 健康意識の高い20〜50代の個人
- **ペルソナ**:
  - 健康診断結果を長期的に管理・比較したい人
  - Fitbit等のウェアラブルデバイスを活用している人
  - 健康習慣を記録・可視化したい人
  - 自身の健康状態を包括的に把握したい人

### 1.3 解決する課題

| 課題 | 解決策 |
|------|--------|
| 健康診断結果が紙やPDFでバラバラに保管され、時系列比較が困難 | OCR技術による自動データ抽出と一元管理 |
| ウェアラブルデバイスのデータが単独アプリに閉じている | Fitbit API連携によるデータ統合 |
| 健康データが多岐にわたり、何を改善すべきか分かりにくい | AIによる健康分析・アドバイス |
| 日々の健康習慣の継続が難しい | 習慣トラッキング機能による可視化 |

### 1.4 主要価値提案

1. **データ統合**: 健康診断 + ウェアラブル + 習慣 = 包括的健康ダッシュボード
2. **自動化**: OCRによる健康診断データの自動読み取り
3. **インテリジェント**: AI (Gemini) による健康分析・改善提案
4. **継続支援**: 習慣トラッキングと推移グラフによるモチベーション維持

---

## 2. 機能要件

### 2.1 認証・ユーザー管理

#### 2.1.1 認証機能
- **FR-AUTH-001**: Google OAuth 2.0 によるソーシャルログイン
- **FR-AUTH-002**: NextAuth.js によるセッション管理
- **FR-AUTH-003**: ログアウト機能

#### 2.1.2 ユーザープロフィール
- **FR-USER-001**: 基本情報（名前、メール、生年月日）の管理
- **FR-USER-002**: プロフィール画像の表示（Googleアカウント画像）

**ロジック詳細**:
```
認証フロー:
1. ユーザーが「Googleでログイン」ボタンをクリック
2. Google OAuth認可画面にリダイレクト
3. 認可完了後、コールバックでトークン取得
4. Prisma Adapterでユーザー情報をDB保存/更新
5. セッション生成、クライアントへ返却
```

### 2.2 健康診断データ管理

#### 2.2.1 OCRアップロード機能
- **FR-OCR-001**: 画像ファイル（JPEG, PNG）のアップロード
- **FR-OCR-002**: 複数ページの健康診断書を一括処理
- **FR-OCR-003**: Gemini AI による健康診断書の自動読み取り
- **FR-OCR-004**: 読み取り結果のプレビュー・編集機能
- **FR-OCR-005**: 検査日付の自動抽出

**OCR処理ロジック**:
```
入力: 画像URL配列 (Supabase Storageに保存済み)
処理:
  1. 画像をBase64エンコード
  2. Gemini 2.5 Pro に画像とプロンプトを送信
  3. プロンプト指示:
     - 日本語標準名で検査項目を抽出
     - 数値・単位・異常フラグ・評価を構造化
     - 複数ページのデータをマージ
  4. JSON形式でパース
出力: {
  date: "YYYY-MM-DD",
  results: [{ category, item, value, unit, isAbnormal, evaluation }],
  meta: { hospitalName, age, notes }
}
```

#### 2.2.2 健康記録管理
- **FR-REC-001**: 健康診断記録の一覧表示
- **FR-REC-002**: 記録の詳細閲覧（検査項目一覧）
- **FR-REC-003**: 記録のステータス管理（pending → verified）
- **FR-REC-004**: 記録の編集・削除
- **FR-REC-005**: 手動入力による記録追加

**データ構造**:
```typescript
HealthRecord {
  id: string
  userId: string
  date: DateTime
  status: "pending" | "verified"
  title?: string
  summary?: string
  data: {
    results: [{
      category: string   // "血液", "肝機能" など
      item: string       // "白血球数", "AST(GOT)" など
      value: number | null
      unit: string
      isAbnormal: boolean
      evaluation: string // "A", "B", "C" など
    }]
    meta?: { hospitalName, age, notes }
  }
  images: string[]  // アップロード画像URL
}
```

#### 2.2.3 検査項目設定
- **FR-ITEM-001**: 検査項目のグラフ表示範囲設定（min/max）
- **FR-ITEM-002**: 基準値の設定（safeMin/safeMax）
- **FR-ITEM-003**: 項目のタグ付け（分類用）
- **FR-ITEM-004**: 項目の統合（別名の名寄せ）
- **FR-ITEM-005**: マスターデータ（JLAC10コード）との紐付け

**項目名寄せロジック**:
```
統合処理:
1. ユーザーがソース項目とターゲット項目を選択
2. ソース項目の履歴データをターゲット項目に移動
3. エイリアス（InspectionItemAlias）を作成
4. 元の項目名でのOCR読み取り時は自動的にターゲットにマッピング
5. 操作履歴を保存（UNDO可能）
```

### 2.3 フィットネスデータ連携

#### 2.3.1 Fitbit連携
- **FR-FIT-001**: Fitbit OAuth 2.0 (PKCE) による認証連携
- **FR-FIT-002**: アクティビティデータ同期（歩数、距離、消費カロリー）
- **FR-FIT-003**: 心拍数データ同期（安静時心拍、ゾーン別時間）
- **FR-FIT-004**: HRV（心拍変動）データ同期
- **FR-FIT-005**: 睡眠データ同期（睡眠時間、ステージ別時間、効率）
- **FR-FIT-006**: 呼吸数・皮膚温度データ同期
- **FR-FIT-007**: 体重データ同期
- **FR-FIT-008**: 自動同期（バックグラウンド/Cron）
- **FR-FIT-009**: 手動同期トリガー

**Fitbit同期ロジック**:
```
同期フロー:
1. FitbitAccountからアクセストークン取得
2. トークン期限切れの場合はリフレッシュ
3. 各データタイプをAPI取得:
   - activity: 歩数・消費カロリー・距離
   - heartrate: 心拍数（1分間隔のintraday）
   - hrv: 心拍変動
   - sleep: 睡眠ログ（ステージ詳細含む）
   - breathing: 呼吸数
   - temperature: 皮膚温度
   - weight: 体重
4. FitData/HrvData/DetailedSleep/IntradayHeartRate テーブルにupsert
5. lastSyncedAt を更新

デフォルト同期期間: 7日間
初回同期: 30日間の履歴データ取得
```

#### 2.3.2 Health Connect連携（モバイル）
- **FR-HC-001**: Capacitor経由でHealth Connectからデータ取得
- **FR-HC-002**: 歩数・心拍・睡眠データの同期

### 2.4 健康プロフィール

#### 2.4.1 プロフィール管理
- **FR-PROF-001**: 11カテゴリの健康プロフィール入力
- **FR-PROF-002**: カスタムカテゴリの追加
- **FR-PROF-003**: フリーテキスト形式での詳細記述
- **FR-PROF-004**: 自動保存機能
- **FR-PROF-005**: テキストエクスポート機能
- **FR-PROF-006**: Google Docs への自動同期

**デフォルトカテゴリ**:
```
1. 基本属性・バイオメトリクス
2. 遺伝・家族歴
3. 病歴・医療ステータス
4. 生理機能・体質
5. 生活リズム
6. 食生活・栄養
7. 嗜好品・サプリメント・薬
8. 運動・身体活動
9. メンタル・脳機能
10. 美容・衛生習慣
11. 環境・社会・ライフスタイル
```

### 2.5 習慣トラッキング

#### 2.5.1 習慣管理
- **FR-HABIT-001**: カスタム習慣の作成
- **FR-HABIT-002**: 習慣タイプの選択（Yes/No型 または 数値型）
- **FR-HABIT-003**: 習慣の色設定
- **FR-HABIT-004**: 習慣の並び替え（ドラッグ&ドロップ）
- **FR-HABIT-005**: 習慣の編集・削除

**習慣タイプ**:
```
yes_no型:
  - 実行: value = 1
  - 未実行: value = 0 or null

numeric型:
  - 数値入力（例: 運動時間 30分）
  - 単位を設定可能（回、時間、分、km など）
```

#### 2.5.2 習慣記録
- **FR-HABIT-006**: 日付別の習慣記録入力
- **FR-HABIT-007**: カレンダー形式での達成状況表示
- **FR-HABIT-008**: 直近30日分の記録取得
- **FR-HABIT-009**: 長押しによる編集・削除モーダル

### 2.6 データ可視化・分析

#### 2.6.1 ダッシュボード
- **FR-DASH-001**: 直近30日間のフィットネストレンド表示
- **FR-DASH-002**: 歩数・心拍数のグラフ
- **FR-DASH-003**: 最新の健康診断記録一覧
- **FR-DASH-004**: ログインユーザーへの挨拶表示

#### 2.6.2 推移グラフ
- **FR-TREND-001**: 検査項目別の時系列推移グラフ
- **FR-TREND-002**: 複数項目の比較表示
- **FR-TREND-003**: 基準値範囲の表示
- **FR-TREND-004**: 期間選択機能

#### 2.6.3 AIヘルスアドバイザー
- **FR-AI-001**: Gemini AI による健康状態の総合分析
- **FR-AI-002**: 7カテゴリ別のスコアリング（0-100点）
- **FR-AI-003**: カテゴリ別の詳細アドバイス
- **FR-AI-004**: 改善優先度の提案

**AIスコアリングロジック**:
```
分析カテゴリ（重要度ランク順）:
  SS: リスク因子、食習慣・栄養
  S:  睡眠・リカバリー、運動・体力
  A:  ストレス・メンタル、社会とのつながり
  B:  予防医療

入力データ:
  - ユーザー基本情報（年齢など）
  - 健康プロフィール全文
  - 直近の健康診断結果

出力:
  - totalScore: 総合スコア
  - categories: 各カテゴリのスコア・サマリー・詳細
  - evaluation: 総合評価文
  - advices: {
      belowAverage: 平均以下のカテゴリへのアドバイス
      badHabits: 改善すべき習慣
      highImpact: 最も効果的な改善策
    }
```

### 2.7 データエクスポート・同期

#### 2.7.1 エクスポート機能
- **FR-EXP-001**: 健康診断記録のテキストエクスポート
- **FR-EXP-002**: 健康プロフィールのテキストエクスポート
- **FR-EXP-003**: クリップボードへのコピー機能

#### 2.7.2 Google Docs連携
- **FR-GDOC-001**: 健康診断記録用ドキュメントの設定
- **FR-GDOC-002**: 健康プロフィール用ドキュメントの設定
- **FR-GDOC-003**: 自動同期ON/OFF設定
- **FR-GDOC-004**: 保存時の自動同期実行

#### 2.7.3 バックアップ機能
- **FR-BAK-001**: 全データのJSONエクスポート
- **FR-BAK-002**: JSONファイルからのインポート
- **FR-BAK-003**: データ整合性検証

### 2.8 サプリメント・薬管理

- **FR-SUP-001**: サプリメント/薬の登録
- **FR-SUP-002**: 服用タイミング設定（朝、昼、夜、就寝前）
- **FR-SUP-003**: 服用量・単位の記録
- **FR-SUP-004**: 開始日・休止期間の管理
- **FR-SUP-005**: メモ・メーカー情報の記録

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 項目 | 要件 |
|------|------|
| ページ初期表示 | 3秒以内（LCP） |
| OCR処理 | 30秒以内/ページ |
| API応答時間 | 500ms以内（95%ile） |
| Fitbit同期 | 60秒以内（7日分） |

### 3.2 セキュリティ

- **NFR-SEC-001**: HTTPS通信の強制
- **NFR-SEC-002**: OAuth 2.0 + PKCE による認証
- **NFR-SEC-003**: セッショントークンの安全な管理
- **NFR-SEC-004**: API Keyの環境変数管理
- **NFR-SEC-005**: ユーザーデータの分離（userId単位）
- **NFR-SEC-006**: SQLインジェクション対策（Prisma ORM）

### 3.3 可用性

- **NFR-AVL-001**: 99.9%のアップタイム（月間）
- **NFR-AVL-002**: Vercel Edgeによるグローバル配信
- **NFR-AVL-003**: Supabase Postgres のマネージドDB

### 3.4 スケーラビリティ

- **NFR-SCL-001**: サーバーレスアーキテクチャによる自動スケーリング
- **NFR-SCL-002**: 1000同時ユーザー対応

### 3.5 保守性

- **NFR-MNT-001**: TypeScript による型安全性
- **NFR-MNT-002**: ESLint による静的解析
- **NFR-MNT-003**: Prisma によるスキーマ管理・マイグレーション

### 3.6 対応環境

| 環境 | 対応 |
|------|------|
| ブラウザ | Chrome, Safari, Firefox, Edge（最新2バージョン） |
| モバイル | Capacitor経由でAndroid対応（PWA） |
| レスポンシブ | モバイル・タブレット・デスクトップ |

---

## 4. 画面一覧

| 画面ID | 画面名 | パス | 概要 |
|--------|--------|------|------|
| SCR-001 | ダッシュボード | `/` | ログイン後のホーム画面 |
| SCR-002 | 推移グラフ | `/trends` | 検査項目の時系列推移 |
| SCR-003 | 健康プロフィール | `/health-profile` | プロフィール入力・閲覧 |
| SCR-004 | 習慣トラッカー | `/habits` | 習慣の記録・管理 |
| SCR-005 | 診断記録一覧 | `/records` | 健康診断記録の一覧 |
| SCR-006 | 診断記録詳細 | `/records/[id]` | 記録の詳細・編集 |
| SCR-007 | インポート | `/import` | OCRアップロード |
| SCR-008 | スマホ連携 | `/smartphone` | Health Connect設定 |
| SCR-009 | DNA | `/dna` | 遺伝子情報（将来拡張） |
| SCR-010 | AIアドバイザー | `/advisor` | AI健康分析レポート |
| SCR-011 | プロフィール | `/profile` | ユーザー設定 |
| SCR-012 | 検査項目設定 | `/profile/settings/items` | 項目の基準値設定 |
| SCR-013 | 項目統合 | `/profile/settings/items/merge` | 項目名の名寄せ |
| SCR-014 | 設定 | `/settings` | アプリ設定 |
| SCR-015 | Fitbit設定 | `/settings/fitbit` | Fitbit連携管理 |
| SCR-016 | Google Docs設定 | `/settings/google-docs` | Docs同期設定 |

---

## 5. 用語定義

| 用語 | 定義 |
|------|------|
| 健康診断記録 (HealthRecord) | 健康診断結果を保存したデータ単位 |
| 検査項目 (InspectionItem) | 血液検査等の個別項目（白血球数、AST等） |
| フィットネスデータ (FitData) | ウェアラブルから取得した日次データ |
| 健康プロフィール | ユーザーの健康に関する詳細情報 |
| 習慣 (Habit) | ユーザーが追跡したい行動パターン |
| 習慣記録 (HabitRecord) | 習慣の日次実績 |

---

## 6. 改訂履歴

| 版 | 日付 | 変更内容 | 作成者 |
|----|------|----------|--------|
| 1.0 | 2026-01-28 | 初版作成 | - |
