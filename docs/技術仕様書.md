# Health Hub - 技術仕様書

## 1. システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Web App    │  │  Mobile App  │  │   PWA        │          │
│  │   (Next.js)  │  │  (Capacitor) │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Vercel Edge Network                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Next.js App Router                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │   │
│  │  │ Server      │  │ API Routes  │  │ Server      │       │   │
│  │  │ Components  │  │ /api/*      │  │ Actions     │       │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   Supabase       │ │   Google Cloud   │ │   Fitbit API     │
│  ┌────────────┐  │ │  ┌────────────┐  │ │                  │
│  │ PostgreSQL │  │ │  │ Gemini AI  │  │ │  - Activity      │
│  │ (Prisma)   │  │ │  │ (2.5 Pro)  │  │ │  - Heart Rate    │
│  └────────────┘  │ │  └────────────┘  │ │  - Sleep         │
│  ┌────────────┐  │ │  ┌────────────┐  │ │  - HRV           │
│  │  Storage   │  │ │  │ Google     │  │ │  - Weight        │
│  │  (Images)  │  │ │  │ Docs API   │  │ └──────────────────┘
│  └────────────┘  │ │  └────────────┘  │
└──────────────────┘ └──────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | バージョン |
|----------|------|------------|
| **フロントエンド** | Next.js | 16.1.1 |
| | React | 19.2.3 |
| | TypeScript | 5.x |
| | Tailwind CSS | 4.x |
| **バックエンド** | Next.js API Routes / Server Actions | - |
| **データベース** | PostgreSQL (Supabase) | - |
| **ORM** | Prisma | 5.22.0 |
| **認証** | NextAuth.js | 4.24.13 |
| **ストレージ** | Supabase Storage | - |
| **AI/OCR** | Google Gemini AI | 2.5 Pro |
| **グラフ** | Recharts | 3.6.0 |
| | Chart.js + react-chartjs-2 | 4.5.1 / 5.3.1 |
| **モバイル** | Capacitor | 8.0.0 |
| **デプロイ** | Vercel | - |

---

## 2. データベース設計

### 2.1 ER図

```
┌─────────────┐     ┌─────────────────────┐     ┌──────────────────┐
│    User     │────<│   HealthRecord      │     │   FitData        │
├─────────────┤     ├─────────────────────┤     ├──────────────────┤
│ id          │     │ id                  │     │ id               │
│ name        │     │ userId (FK)         │     │ userId (FK)      │
│ email       │     │ date                │     │ date             │
│ birthDate   │     │ status              │     │ heartRate        │
└─────────────┘     │ title               │     │ steps            │
       │            │ summary             │     │ weight           │
       │            │ data (JSON)         │     │ sleepMinutes     │
       │            │ images[]            │     │ source           │
       │            └─────────────────────┘     └──────────────────┘
       │
       │     ┌─────────────────────┐     ┌──────────────────────┐
       ├────<│ HealthProfileSection│     │ InspectionItem       │
       │     ├─────────────────────┤     ├──────────────────────┤
       │     │ id                  │     │ id                   │
       │     │ userId (FK)         │     │ userId (FK)          │
       │     │ categoryId          │     │ name                 │
       │     │ title               │     │ masterItemCode (FK)  │
       │     │ content             │     └──────────────────────┘
       │     │ orderIndex          │              │
       │     └─────────────────────┘              │
       │                                          │
       │     ┌─────────────────────┐     ┌───────┴──────────────┐
       ├────<│ Habit               │     │ InspectionItemAlias  │
       │     ├─────────────────────┤     ├──────────────────────┤
       │     │ id                  │     │ inspectionItemId(FK) │
       │     │ userId (FK)         │     │ originalName         │
       │     │ name                │     └──────────────────────┘
       │     │ type (yes_no/numeric)│
       │     │ unit                │
       │     │ color               │
       │     └─────────────────────┘
       │              │
       │              ▼
       │     ┌─────────────────────┐
       └────<│ HabitRecord         │
             ├─────────────────────┤
             │ id                  │
             │ habitId (FK)        │
             │ userId (FK)         │
             │ date                │
             │ value               │
             └─────────────────────┘
```

### 2.2 テーブル詳細

#### 2.2.1 User テーブル

```prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  birthDate     DateTime?

  // リレーション
  accounts              Account[]
  sessions              Session[]
  healthRecords         HealthRecord[]
  fitData               FitData[]
  healthItemSettings    UserHealthItemSetting[]
  lifestyleHabits       LifestyleHabit[]
  supplements           Supplement[]
  inspectionItems       InspectionItem[]
  healthProfileSections HealthProfileSection[]
  googleDocsSettings    GoogleDocsSettings?
  fitbitAccount         FitbitAccount?
  hrvData               HrvData[]
  detailedSleep         DetailedSleep[]
  intradayHeartRate     IntradayHeartRate[]
  habits                Habit[]
  habitRecords          HabitRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

#### 2.2.2 HealthRecord テーブル

```prisma
model HealthRecord {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  status          String   @default("pending") // pending | verified
  title           String?
  summary         String?
  data            Json     // 検査結果データ
  additional_data Json?    // 追加項目
  images          String[] // 画像URL配列

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**data フィールドの構造**:
```typescript
interface HealthRecordData {
  results: {
    category: string;    // カテゴリ（血液、肝機能など）
    item: string;        // 項目名
    value: number | null;
    unit: string;
    isAbnormal: boolean;
    evaluation: string;  // A, B, C など
  }[];
  meta?: {
    hospitalName?: string;
    age?: number;
    notes?: string;
  };
}
```

#### 2.2.3 FitData テーブル

```prisma
model FitData {
  id               String   @id @default(cuid())
  userId           String
  date             DateTime

  // 基本フィットネスデータ
  heartRate        Float?   // 安静時心拍数
  steps            Int?     // 歩数
  weight           Float?   // 体重 (kg)
  distance         Float?   // 距離 (meters)
  calories         Float?   // 消費カロリー (kcal)
  sleepMinutes     Int?     // 睡眠時間 (分)

  // 詳細データ (JSON)
  sleepData        Json?    // 睡眠セッション詳細
  vitals           Json?    // 血圧等
  workouts         Json?    // ワークアウトログ
  raw              Json?    // 生データ

  // データソース
  source           String?  // 'health_connect' | 'fitbit' | 'merged'
  fitbitSyncId     String?
  respiratoryRate  Float?   // 呼吸数
  skinTemperature  Float?   // 皮膚温度変動

  syncedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}
```

#### 2.2.4 Habit / HabitRecord テーブル

```prisma
model Habit {
  id      String @id @default(cuid())
  userId  String
  name    String             // 習慣名
  type    String             // "yes_no" | "numeric"
  unit    String?            // 数値型の単位
  color   String @default("#3B82F6")
  order   Int    @default(0) // 表示順

  records HabitRecord[]
  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model HabitRecord {
  id      String   @id @default(cuid())
  habitId String
  userId  String
  date    DateTime @db.Date
  value   Float?   // Yes/No: 1 or 0, Numeric: 実数値

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@index([userId, date])
}
```

#### 2.2.5 HealthProfileSection テーブル

```prisma
model HealthProfileSection {
  id         String @id @default(cuid())
  userId     String
  categoryId String   // カテゴリ識別子
  title      String   // カテゴリ表示名
  content    String   @db.Text // フリーテキスト
  orderIndex Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
}
```

#### 2.2.6 Fitbit関連テーブル

```prisma
// Fitbit OAuth接続
model FitbitAccount {
  id              String   @id @default(cuid())
  userId          String   @unique
  fitbitUserId    String
  accessToken     String   @db.Text
  refreshToken    String   @db.Text
  expiresAt       DateTime
  scope           String
  tokenType       String   @default("Bearer")
  codeVerifier    String?  @db.Text
  lastSyncedAt    DateTime?
  initialSyncCompleted Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// HRVデータ
model HrvData {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @db.Date
  dailyRmssd    Float    // RMSSD値 (ms)
  deepRmssd     Float?   // 深睡眠時RMSSD
  coverage      Float?   // データカバレッジ (%)
  lowFrequency  Float?
  highFrequency Float?
  raw           Json?

  @@unique([userId, date])
  @@index([userId, date])
}

// 詳細睡眠データ
model DetailedSleep {
  id           String   @id @default(cuid())
  userId       String
  date         DateTime @db.Date
  logId        String   // Fitbit睡眠ログID
  startTime    DateTime
  endTime      DateTime
  duration     Int      // 睡眠時間 (分)
  efficiency   Int      // 睡眠効率 (%)
  minutesAwake Int
  minutesLight Int
  minutesDeep  Int
  minutesRem   Int
  stages       Json     // 30秒間隔のステージデータ
  raw          Json?

  @@unique([userId, logId])
  @@index([userId, date])
}

// 心拍数詳細データ
model IntradayHeartRate {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @db.Date
  restingHeartRate  Int?
  outOfRangeMinutes Int?
  fatBurnMinutes    Int?
  cardioMinutes     Int?
  peakMinutes       Int?
  intradayData      Json     // 1分間隔のデータ
  raw               Json?

  @@unique([userId, date])
  @@index([userId, date])
}
```

---

## 3. API設計

### 3.1 API Routes一覧

| メソッド | パス | 概要 |
|----------|------|------|
| POST | `/api/auth/[...nextauth]` | NextAuth認証エンドポイント |
| GET | `/api/habits` | 習慣一覧取得 |
| POST | `/api/habits` | 習慣作成 |
| PATCH | `/api/habits` | 習慣順序更新 |
| GET | `/api/habits/[habitId]` | 習慣詳細取得 |
| PUT | `/api/habits/[habitId]` | 習慣更新 |
| DELETE | `/api/habits/[habitId]` | 習慣削除 |
| POST | `/api/habits/[habitId]/records` | 習慣記録追加 |
| GET | `/api/fitbit/auth` | Fitbit認証開始 |
| GET | `/api/fitbit/callback` | Fitbit OAuthコールバック |
| POST | `/api/fitbit/sync` | Fitbit同期実行 |
| GET | `/api/fitbit/status` | Fitbit接続状態取得 |
| POST | `/api/fitbit/disconnect` | Fitbit連携解除 |
| POST | `/api/report/analyze` | AI健康分析実行 |
| GET | `/api/v1/health-connect/sync` | Health Connect同期 |
| GET | `/api/cron/fitbit-sync` | Fitbit自動同期 (Cron) |
| GET | `/api/admin/backup/export` | バックアップエクスポート |
| POST | `/api/admin/backup/import` | バックアップインポート |
| GET | `/api/admin/backup/status` | バックアップ状態 |

### 3.2 Server Actions一覧

| 関数名 | ファイル | 概要 |
|--------|----------|------|
| `getDashboardData` | `/actions/dashboard.ts` | ダッシュボードデータ取得 |
| `processHealthCheckDocuments` | `/actions/ocr.ts` | OCR画像処理 |
| `parseHealthCheckText` | `/actions/ocr.ts` | テキスト解析 |
| `getHealthProfile` | `/actions/health-profile.ts` | プロフィール取得 |
| `saveAllHealthProfileSections` | `/actions/health-profile.ts` | プロフィール一括保存 |
| `addCustomCategory` | `/actions/health-profile.ts` | カスタムカテゴリ追加 |
| `deleteCategory` | `/actions/health-profile.ts` | カテゴリ削除 |
| `exportHealthProfileAsText` | `/actions/health-profile.ts` | プロフィールエクスポート |
| `saveHealthRecord` | `/actions/health-record.ts` | 健康記録保存 |
| `getRecords` | `/actions/records.ts` | 記録一覧取得 |
| `analyzeHealthData` | `/actions/analyze-health.ts` | AI健康分析 |
| `getStructuredDataForAnalysis` | `/actions/report.ts` | 分析用データ取得 |
| `getTrendData` | `/actions/trends.ts` | 推移データ取得 |
| `getItems` | `/actions/items.ts` | 検査項目取得 |
| `mergeItems` | `/actions/items.ts` | 項目統合 |
| `syncFitbitNow` | `/actions/fitbit-sync.ts` | Fitbit同期実行 |
| `getSupplements` | `/actions/supplements.ts` | サプリメント取得 |

### 3.3 API詳細仕様

#### 3.3.1 習慣API

**GET /api/habits**

レスポンス:
```json
{
  "habits": [
    {
      "id": "clx...",
      "name": "運動",
      "type": "yes_no",
      "unit": null,
      "color": "#3B82F6",
      "order": 0,
      "records": [
        {
          "id": "clx...",
          "date": "2026-01-28",
          "value": 1
        }
      ]
    }
  ]
}
```

**POST /api/habits**

リクエスト:
```json
{
  "name": "読書",
  "type": "numeric",
  "unit": "分",
  "color": "#10B981"
}
```

レスポンス:
```json
{
  "habit": {
    "id": "clx...",
    "name": "読書",
    "type": "numeric",
    "unit": "分",
    "color": "#10B981",
    "order": 1
  }
}
```

#### 3.3.2 Fitbit同期API

**POST /api/fitbit/sync**

リクエスト:
```json
{
  "startDate": "2026-01-21",
  "endDate": "2026-01-28",
  "dataTypes": ["activity", "heartrate", "sleep"]
}
```

レスポンス:
```json
{
  "success": true,
  "syncedAt": "2026-01-28T10:00:00Z",
  "data": {
    "activity": { "count": 7 },
    "heartrate": { "count": 7 },
    "sleep": { "count": 7 }
  },
  "errors": []
}
```

---

## 4. 外部連携仕様

### 4.1 Google OAuth 2.0

**設定**:
- Client ID: 環境変数 `GOOGLE_CLIENT_ID`
- Client Secret: 環境変数 `GOOGLE_CLIENT_SECRET`
- Redirect URI: `{BASE_URL}/api/auth/callback/google`
- Scopes: `openid`, `email`, `profile`

**認証フロー**:
```
1. ユーザー → /api/auth/signin/google
2. Google認証画面へリダイレクト
3. 認可後 → /api/auth/callback/google
4. NextAuth がトークン検証・セッション生成
5. User テーブルに upsert
6. ダッシュボードへリダイレクト
```

### 4.2 Fitbit API

**OAuth 2.0 + PKCE**:
```
1. /api/fitbit/auth
   - code_verifier 生成・保存
   - code_challenge 生成 (S256)
   - Fitbit認可URLへリダイレクト

2. /api/fitbit/callback
   - authorization_code + code_verifier でトークン取得
   - FitbitAccount テーブルに保存

3. トークンリフレッシュ
   - expiresAt < now() の場合
   - refresh_token でアクセストークン更新
```

**APIエンドポイント**:
- Activity Summary: `GET /1/user/-/activities/date/{date}.json`
- Heart Rate: `GET /1/user/-/activities/heart/date/{date}/1d/1min.json`
- HRV: `GET /1/user/-/hrv/date/{start}/{end}.json`
- Sleep: `GET /1.2/user/-/sleep/date/{start}/{end}.json`
- Breathing Rate: `GET /1/user/-/br/date/{start}/{end}.json`
- Skin Temperature: `GET /1/user/-/temp/skin/date/{start}/{end}.json`
- Weight: `GET /1/user/-/body/log/weight/date/{start}/{end}.json`

**レート制限**:
- 150リクエスト/時間 (Personal Apps)
- Intraday データは承認アプリのみ

### 4.3 Google Gemini AI

**モデル**: `gemini-2.5-pro`

**OCR処理**:
```typescript
// 画像をBase64エンコード
const imagesParts = images.map(url => ({
  inlineData: {
    data: base64Data,
    mimeType: 'image/jpeg'
  }
}));

// API呼び出し
const result = await model.generateContent([
  { text: prompt },
  ...imagesParts
]);
```

**健康分析**:
```typescript
const response = await fetch(
  `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${API_KEY}`,
  {
    method: 'POST',
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 8192,
        responseMimeType: "application/json",
        responseSchema: schema
      }
    })
  }
);
```

### 4.4 Google Docs API

**Scopes**:
- `https://www.googleapis.com/auth/documents`

**同期処理**:
```typescript
// ドキュメントの内容をクリア
await docs.documents.batchUpdate({
  documentId: docId,
  requestBody: {
    requests: [
      // 既存コンテンツ削除
      { deleteContentRange: { ... } },
      // 新規コンテンツ挿入
      { insertText: { text: content, location: { index: 1 } } }
    ]
  }
});
```

---

## 5. セキュリティ設計

### 5.1 認証・認可

| 項目 | 実装 |
|------|------|
| 認証方式 | OAuth 2.0 (Google) |
| セッション管理 | NextAuth.js JWT |
| CSRF対策 | NextAuth組み込み |
| 認可 | Server側でuserId検証 |

### 5.2 データ保護

```typescript
// 全APIでユーザー認証チェック
const session = await getServerSession(authOptions);
if (!session?.user?.email) {
  return { error: 'Unauthorized' };
}

// データアクセスはuserIdでフィルタリング
const user = await prisma.user.findUnique({
  where: { email: session.user.email }
});
const records = await prisma.healthRecord.findMany({
  where: { userId: user.id }
});
```

### 5.3 環境変数管理

```env
# 認証
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
NEXTAUTH_SECRET=
NEXTAUTH_URL=

# データベース
DATABASE_URL=
DIRECT_URL=

# 外部API
GOOGLE_API_KEY=           # Gemini AI
FITBIT_CLIENT_ID=
FITBIT_CLIENT_SECRET=

# ストレージ
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
```

---

## 6. パフォーマンス設計

### 6.1 最適化戦略

| 領域 | 戦略 |
|------|------|
| SSR/SSG | App Router によるサーバーコンポーネント優先 |
| データキャッシュ | SWR によるクライアントキャッシュ |
| 画像最適化 | Next.js Image + Supabase CDN |
| バンドル最適化 | 動的インポート、Tree Shaking |
| DB クエリ | Prisma の select/include 最適化 |

### 6.2 キャッシング戦略

```typescript
// SWR によるデータフェッチ
const { data, mutate } = useSWR('/api/habits', fetcher, {
  revalidateOnFocus: false,
  revalidateOnReconnect: true,
  dedupingInterval: 60000 // 1分
});

// サーバー側キャッシュ (Next.js)
export const revalidate = 60; // 60秒
```

---

## 7. エラーハンドリング

### 7.1 エラー分類

| コード | 種別 | 対応 |
|--------|------|------|
| 401 | 未認証 | ログイン画面へリダイレクト |
| 403 | 認可エラー | エラーメッセージ表示 |
| 404 | Not Found | 404ページ表示 |
| 422 | バリデーションエラー | フィールドエラー表示 |
| 500 | サーバーエラー | 汎用エラーメッセージ + ログ記録 |

### 7.2 エラーハンドリング実装

```typescript
// Server Action
export async function saveHealthRecord(data: any) {
  try {
    const session = await getServerSession(authOptions);
    if (!session) {
      return { success: false, error: 'Unauthorized' };
    }

    // バリデーション
    if (!data.date) {
      return { success: false, error: 'Date is required' };
    }

    // DB操作
    const record = await prisma.healthRecord.create({ ... });
    return { success: true, data: record };

  } catch (error) {
    console.error('Failed to save record:', error);
    return { success: false, error: 'Failed to save record' };
  }
}
```

### 7.3 通知コンポーネント

```typescript
// react-hot-toast による通知
import toast from 'react-hot-toast';

// 成功
toast.success('保存しました');

// エラー
toast.error('保存に失敗しました');

// カスタム
toast.custom((t) => (
  <ErrorToast message={error} onDismiss={() => toast.dismiss(t.id)} />
));
```

---

## 8. デプロイメント

### 8.1 環境構成

| 環境 | URL | 用途 |
|------|-----|------|
| Production | `https://health-hub.vercel.app` | 本番環境 |
| Preview | `https://health-hub-*.vercel.app` | PR プレビュー |
| Development | `http://localhost:3000` | ローカル開発 |

### 8.2 CI/CD フロー

```
1. Git Push → GitHub
2. Vercel 自動ビルド
   - pnpm install
   - prisma generate
   - next build
3. Preview Deploy (PRブランチ)
4. Production Deploy (main マージ)
```

### 8.3 Prisma マイグレーション

```bash
# 開発環境
npx prisma migrate dev --name add_feature

# 本番環境 (Vercel Build時)
npx prisma generate
# マイグレーションは手動実行または prisma migrate deploy
```

---

## 9. 監視・ログ

### 9.1 ログ出力

```typescript
// サーバーサイドログ
console.log('[Dashboard]', 'Fetching data for user:', userId);
console.error('[OCR Error]', error);

// Vercel ログで確認可能
```

### 9.2 エラートラッキング

- Vercel Runtime Logs
- Server Action エラーキャッチ
- クライアントサイド ErrorBoundary (将来実装)

---

## 10. 改訂履歴

| 版 | 日付 | 変更内容 | 作成者 |
|----|------|----------|--------|
| 1.0 | 2026-01-28 | 初版作成 | - |
